# Story 2.2: Integrate Journey Animation into Weather Fetch Flow

**Epic:** 2 - API Journey Visualization  
**Status:** Draft  
**Story Points:** 2  
**Priority:** High  
**Created:** 2025-10-27  
**Updated:** 2025-10-27  

---

## User Story

**As a** user,  
**I want** to see which step the app is on when fetching weather,  
**so that** I understand the process and know the app is working.

---

## Story Description

Replace LoadingSpinner with ApiJourneyAnimation in main.ts, emit progress events from service calls, and coordinate timing between actual API calls and animation stages. Ensure error states transition appropriately.

---

## Acceptance Criteria

1. ✅ ApiJourneyAnimation replaces LoadingSpinner in main.ts
2. ✅ Animation shows "geocoding" stage during geocode API call
3. ✅ Animation transitions to "weather" stage during weather API call
4. ✅ Animation shows "complete" briefly before results display
5. ✅ Error states properly interrupt animation and show error message
6. ✅ Animation respects minimum stage duration (1.5s per stage)
7. ✅ LoadingSpinner component remains in codebase for potential rollback
8. ✅ No regression in existing weather lookup functionality
9. ✅ Integration tests verify animation stages
10. ✅ Manual UAT confirms smooth user experience

---

## Dev Notes

### Previous Story Insights
[Source: Story 2.1 - API Journey Animation Component]
- ApiJourneyAnimation component created with `show()`, `hide()`, `updateStage()` methods
- Component accepts stages: `'idle' | 'geocoding' | 'weather' | 'complete'`
- Component handles timing internally with minimum stage durations
- Component has same public API as LoadingSpinner for easy swap

### Integration Points

**Main Application File:**
[Source: docs/architecture/project-structure.md]
- File: `src/main.ts`
- Current flow: WeatherForm → LoadingSpinner → API calls → WeatherDisplay/ErrorMessage
- New flow: WeatherForm → ApiJourneyAnimation (with stage updates) → API calls → WeatherDisplay/ErrorMessage

**Current Implementation Pattern:**
[Source: src/main.ts - existing code]
```typescript
const loadingSpinner = new LoadingSpinner(document.body);

const fetchWeather = async (zipCode: string) => {
  try {
    errorMessage.hide();
    loadingSpinner.show(); // <- Replace with animation

    const geocodeResult = await geocodeZipCode(zipCode); // <- Emit geocoding stage
    const weatherData = await getWeatherByCoordinates(...); // <- Emit weather stage

    loadingSpinner.hide(); // <- Hide after complete stage
    weatherDisplay.display(weatherData);
  } catch (error) {
    loadingSpinner.hide(); // <- Ensure animation stops on error
    errorMessage.show(...);
  }
};
```

### Service Layer Context

**Geocoding Service:**
[Source: src/services/geocoding.service.ts]
- Function: `geocodeZipCode(zipCode: string): Promise<GeocodeResult>`
- API: Zippopotam.us
- No changes needed to service - call it normally

**Weather Service:**
[Source: src/services/weather.service.ts]
- Function: `getWeatherByCoordinates(coordinates: Coordinates, zipCode: string): Promise<WeatherData>`
- API: National Weather Service
- No changes needed to service - call it normally

### Component Specifications

**Import Updates:**
```typescript
// OLD:
import { LoadingSpinner } from './components/LoadingSpinner';

// NEW:
import { ApiJourneyAnimation } from './components/ApiJourneyAnimation';
// Keep LoadingSpinner import commented for rollback option
```

**Initialization:**
```typescript
// Replace:
const loadingSpinner = new LoadingSpinner(document.body);

// With:
const apiJourney = new ApiJourneyAnimation(document.body);
```

**Stage Update Pattern:**
```typescript
apiJourney.show();
apiJourney.updateStage('geocoding');
// ... call geocode API ...
apiJourney.updateStage('weather');
// ... call weather API ...
apiJourney.updateStage('complete');
// ... brief pause for "complete" state ...
apiJourney.hide();
```

### Timing Coordination

[Source: Epic 2 - Animation timing strategy]
- Component handles minimum stage durations internally (1.5s per stage)
- Don't need complex timing logic in main.ts
- Simply call `updateStage()` when each API call starts
- Component will ensure smooth educational pace

### Error Handling Integration

[Source: src/main.ts, src/utils/error-messages.ts]
- If error occurs during any stage, call `apiJourney.hide()` immediately
- ErrorMessage component takes over display
- Animation should gracefully interrupt without jarring transition
- Test scenarios:
  - Geocoding fails (stage 1 error)
  - Weather API fails (stage 2 error)
  - Network error at any stage

### File Locations

**Files to Modify:**
- `src/main.ts` - Replace LoadingSpinner with ApiJourneyAnimation

**Files Referenced (No Changes):**
- `src/components/LoadingSpinner.ts` - Keep for rollback
- `src/services/geocoding.service.ts` - Use as-is
- `src/services/weather.service.ts` - Use as-is
- `src/components/ErrorMessage.ts` - Use as-is
- `src/components/WeatherDisplay.ts` - Use as-is

[Source: docs/architecture/project-structure.md]

### Testing Requirements

[Source: docs/architecture/testing-strategy.md]

**Integration Test:**
- File: `tests/integration/weather-flow.test.ts` (update existing or add new)
- Mock API calls with controlled delays
- Verify animation shows during fetch
- Verify stage transitions occur
- Verify animation hides after completion
- Verify animation stops on error

**Manual UAT:**
- Enter valid zip code → watch animation stages
- Verify smooth transitions (geocoding → weather → complete → results)
- Enter invalid zip code → verify animation stops and error shows
- Test on mobile device → verify animation works
- Check network throttling → verify minimum durations work

### Technical Constraints

[Source: docs/architecture/coding-standards.md]
- **No breaking changes:** Existing functionality must work exactly as before
- **Error handling preserved:** All error states still handled correctly
- **TypeScript strict mode:** Type all variables and function returns
- **Rollback plan:** Keep LoadingSpinner import commented, not deleted

[Source: Epic 2 - Risk Mitigation]
- **Simple rollback:** Change one import and one variable name to revert
- **Test existing functionality:** Run existing test suite to verify no regression

---

## Tasks / Subtasks

### Task 1: Import and Initialize ApiJourneyAnimation (AC: 1)
[Source: src/main.ts, Story 2.1 component API]
- [ ] Comment out LoadingSpinner import (keep for rollback)
- [ ] Import ApiJourneyAnimation from `./components/ApiJourneyAnimation`
- [ ] Replace `loadingSpinner` variable with `apiJourney`
- [ ] Initialize: `const apiJourney = new ApiJourneyAnimation(document.body);`
- [ ] Verify TypeScript compiles without errors

### Task 2: Update fetchWeather Function - Geocoding Stage (AC: 2, 6)
[Source: src/main.ts fetchWeather function]
- [ ] Replace `loadingSpinner.show()` with `apiJourney.show()`
- [ ] Add `apiJourney.updateStage('geocoding')` immediately after show
- [ ] Keep `await geocodeZipCode(zipCode)` call unchanged
- [ ] Verify geocoding stage displays during API call

### Task 3: Add Weather Stage Transition (AC: 3, 6)
[Source: src/main.ts fetchWeather function]
- [ ] After geocode completes, add `apiJourney.updateStage('weather')`
- [ ] Keep `await getWeatherByCoordinates(...)` call unchanged
- [ ] Verify weather stage displays during weather API call

### Task 4: Handle Completion and Display (AC: 4)
[Source: src/main.ts fetchWeather function, Story 2.1 timing]
- [ ] After weather API completes, add `apiJourney.updateStage('complete')`
- [ ] Add brief delay (300ms) to show "complete" state
- [ ] Call `apiJourney.hide()` 
- [ ] Display weather results with `weatherDisplay.display(weatherData)`

### Task 5: Update Error Handling (AC: 5)
[Source: src/main.ts fetchWeather catch block]
- [ ] In catch block, replace `loadingSpinner.hide()` with `apiJourney.hide()`
- [ ] Ensure animation stops immediately on error
- [ ] Verify error message still displays correctly
- [ ] Test all error scenarios (geocoding fail, weather API fail, network error)

### Task 6: Create/Update Integration Test (AC: 9)
[Source: tests/integration/weather-flow.test.ts]
- [ ] Create or update integration test file
- [ ] Mock geocodeZipCode and getWeatherByCoordinates
- [ ] Test: Animation shows when fetchWeather called
- [ ] Test: Stages transition correctly (geocoding → weather → complete)
- [ ] Test: Animation hides after completion
- [ ] Test: Animation stops on geocoding error
- [ ] Test: Animation stops on weather API error
- [ ] Run test: `npm run test`

### Task 7: Manual Testing and Verification (AC: 8, 10)
- [ ] Start dev server: `npm run dev`
- [ ] Test valid zip code (10001) → verify smooth animation flow
- [ ] Test invalid zip code (00000) → verify error handling
- [ ] Test slow network → verify minimum stage durations work
- [ ] Test on mobile device or responsive mode
- [ ] Verify no console errors
- [ ] Run full test suite: `npm run test`
- [ ] Run linter: `npm run lint`
- [ ] Run type check: `npm run type-check`

### Task 8: Verify Rollback Plan (AC: 7)
- [ ] Verify LoadingSpinner import is commented (not deleted)
- [ ] Document rollback steps in commit message
- [ ] Ensure LoadingSpinner.ts file still exists in codebase
- [ ] Test that uncommenting LoadingSpinner import would work

---

## Definition of Done

- [x] All acceptance criteria met
- [x] ApiJourneyAnimation integrated into main.ts
- [x] All three stages display correctly during weather fetch
- [x] Error handling preserves existing functionality
- [x] Integration tests pass
- [x] Existing test suite passes (no regression)
- [x] Manual UAT completed successfully
- [x] No TypeScript errors
- [x] No ESLint errors
- [x] LoadingSpinner kept in codebase for rollback
- [x] Works on mobile and desktop
- [x] Git commit with clear message

---

## Dependencies

**Depends On:**
- Story 2.1 (ApiJourneyAnimation component must be complete)

**Blocks:**
- Story 2.3 (Polish and Accessibility)

---

## Technical Risks

### Risk 1: Timing Feels Off or Jarring
**Impact:** Medium  
**Mitigation:** Component handles timing internally, test with various network speeds, adjust minimum durations if needed

### Risk 2: Error Interruption Not Smooth
**Impact:** Low  
**Mitigation:** Test all error scenarios, ensure hide() method has proper fade-out even when interrupted

---

## Notes

- Keep changes minimal - only modify main.ts
- Don't change service layer at all
- Focus on smooth user experience
- Easy rollback is critical for production safety

---

## Dev Agent Record

### Implementation Start
*To be filled by Dev Agent when starting implementation*

### Completion Notes
*To be filled by Dev Agent upon completion*

### Debug Log Reference
*To be filled if debugging is required*

